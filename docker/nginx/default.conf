# Rate limiting zones
# General API rate limiting: 100 requests per minute per IP
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/m;

# Stricter limit for file uploads: 10 uploads per minute per IP
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=10r/m;

# Very strict limit for scan creation: 20 scans per minute per IP
limit_req_zone $binary_remote_addr zone=scan_limit:10m rate=20r/m;

server {
    listen 80 default;
    server_name localhost;
    root /var/www/html/public;

    # Increase max post size to allow for large dependency files
    client_max_body_size 100M;

    # Custom 429 error page with JSON response
    error_page 429 /429.json;
    location = /429.json {
        internal;
        default_type application/json;
        return 429 '{"error":"Too many requests. Please slow down and try again later."}';
    }

    # Rate limit for file uploads (most specific - must come first)
    location ~ ^/api/scans/.+/files$ {
        limit_req zone=upload_limit burst=5 nodelay;
        limit_req_status 429;
        try_files $uri /index.php$is_args$args;
    }

    # Rate limit for scan creation (second most specific)
    location ~ ^/api/repositories/.+/scans$ {
        limit_req zone=scan_limit burst=10 nodelay;
        limit_req_status 429;
        try_files $uri /index.php$is_args$args;
    }

    # General rate limit for all other API endpoints (least specific, should match last)
    location ~ ^/api/ {
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;
        try_files $uri /index.php$is_args$args;
    }

    location / {
        # try to serve file directly, fallback to app.php
        try_files $uri /index.php$is_args$args;
    }
    
    location ~ ^/index\.php(/|$) {
        fastcgi_pass php:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $document_root;
        fastcgi_param APP_DEV_PERMITTED "true";
        fastcgi_param APP_ENV dev;
        fastcgi_param APP_DEBUG 1;
        fastcgi_hide_header X-Powered-By;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 4 16k;
        fastcgi_read_timeout 600;
   }

   error_log /var/log/nginx/error.log;
   access_log /var/log/nginx/access.log;
}
