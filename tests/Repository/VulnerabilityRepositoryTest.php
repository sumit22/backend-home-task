<?php

namespace App\Tests\Repository;

use App\Entity\Provider;
use App\Entity\Repository;
use App\Entity\RepositoryScan;
use App\Entity\Vulnerability;
use App\Repository\VulnerabilityRepository;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Test\KernelTestCase;

class VulnerabilityRepositoryTest extends KernelTestCase
{
    private EntityManagerInterface $entityManager;
    private VulnerabilityRepository $repository;
    private RepositoryScan $testScan;

    protected function setUp(): void
    {
        $kernel = self::bootKernel();

        $this->entityManager = $kernel->getContainer()
            ->get('doctrine')
            ->getManager();

        $this->repository = $this->entityManager->getRepository(Vulnerability::class);

        // Create test provider
        $provider = new Provider();
        $provider->setName('Test Provider');
        $provider->setCode('sca_test');
        $this->entityManager->persist($provider);

        // Create test repository
        $repo = new Repository();
        $repo->setProvider($provider);
        $repo->setName('test/repo');
        $repo->setDefaultBranch('main');
        $this->entityManager->persist($repo);

        // Create test scan
        $this->testScan = new RepositoryScan();
        $this->testScan->setRepository($repo);
        $this->testScan->setStatus('completed');
        $this->testScan->setBranch('main');
        $this->entityManager->persist($this->testScan);

        $this->entityManager->flush();
    }

    protected function tearDown(): void
    {
        // Clean up test data
        $vulnerabilities = $this->repository->findAll();
        foreach ($vulnerabilities as $vulnerability) {
            $this->entityManager->remove($vulnerability);
        }
        $this->entityManager->flush();

        parent::tearDown();
        $this->entityManager->close();
    }

    public function testCanCreateVulnerability(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setScan($this->testScan);
        $vulnerability->setTitle('SQL Injection vulnerability');
        $vulnerability->setCve('CVE-2023-12345');
        $vulnerability->setSeverity('high');
        $vulnerability->setScore('7.5');
        $vulnerability->setIgnored(false);

        $this->entityManager->persist($vulnerability);
        $this->entityManager->flush();

        $found = $this->repository->find($vulnerability->getId());

        $this->assertNotNull($found);
        $this->assertEquals('SQL Injection vulnerability', $found->getTitle());
        $this->assertEquals('CVE-2023-12345', $found->getCve());
        $this->assertEquals('high', $found->getSeverity());
    }

    public function testCanFindVulnerabilitiesBySeverity(): void
    {
        $highVuln = new Vulnerability();
        $highVuln->setScan($this->testScan);
        $highVuln->setTitle('High Severity Issue');
        $highVuln->setSeverity('high');
        $highVuln->setIgnored(false);

        $lowVuln = new Vulnerability();
        $lowVuln->setScan($this->testScan);
        $lowVuln->setTitle('Low Severity Issue');
        $lowVuln->setSeverity('low');
        $lowVuln->setIgnored(false);

        $this->entityManager->persist($highVuln);
        $this->entityManager->persist($lowVuln);
        $this->entityManager->flush();

        $highVulns = $this->repository->findBy(['severity' => 'high']);
        $lowVulns = $this->repository->findBy(['severity' => 'low']);

        $this->assertCount(1, $highVulns);
        $this->assertCount(1, $lowVulns);
    }

    public function testCanFilterIgnoredVulnerabilities(): void
    {
        $activeVuln = new Vulnerability();
        $activeVuln->setScan($this->testScan);
        $activeVuln->setTitle('Active Vulnerability');
        $activeVuln->setSeverity('medium');
        $activeVuln->setIgnored(false);

        $ignoredVuln = new Vulnerability();
        $ignoredVuln->setScan($this->testScan);
        $ignoredVuln->setTitle('Ignored Vulnerability');
        $ignoredVuln->setSeverity('medium');
        $ignoredVuln->setIgnored(true);

        $this->entityManager->persist($activeVuln);
        $this->entityManager->persist($ignoredVuln);
        $this->entityManager->flush();

        $activeVulns = $this->repository->findBy(['ignored' => false]);
        $ignoredVulns = $this->repository->findBy(['ignored' => true]);

        $this->assertCount(1, $activeVulns);
        $this->assertCount(1, $ignoredVulns);
    }

    public function testCanStorePackageInformation(): void
    {
        $vulnerability = new Vulnerability();
        $vulnerability->setScan($this->testScan);
        $vulnerability->setTitle('Vulnerable Package');
        $vulnerability->setSeverity('critical');
        $vulnerability->setPackageName('lodash');
        $vulnerability->setPackageVersion('4.17.15');
        $vulnerability->setEcosystem('npm');
        $vulnerability->setFixedIn('4.17.21');
        $vulnerability->setIgnored(false);

        $this->entityManager->persist($vulnerability);
        $this->entityManager->flush();

        $found = $this->repository->find($vulnerability->getId());

        $this->assertEquals('lodash', $found->getPackageName());
        $this->assertEquals('4.17.15', $found->getPackageVersion());
        $this->assertEquals('npm', $found->getEcosystem());
        $this->assertEquals('4.17.21', $found->getFixedIn());
    }

    public function testCanStoreReferencesAsJson(): void
    {
        $references = [
            'https://nvd.nist.gov/vuln/detail/CVE-2023-12345',
            'https://github.com/advisories/GHSA-xxxx-yyyy-zzzz'
        ];

        $vulnerability = new Vulnerability();
        $vulnerability->setScan($this->testScan);
        $vulnerability->setTitle('Test Vulnerability');
        $vulnerability->setSeverity('high');
        $vulnerability->setReferences($references);
        $vulnerability->setIgnored(false);

        $this->entityManager->persist($vulnerability);
        $this->entityManager->flush();

        $found = $this->repository->find($vulnerability->getId());

        $this->assertEquals($references, $found->getReferences());
        $this->assertCount(2, $found->getReferences());
    }

    public function testCanFindVulnerabilitiesByScan(): void
    {
        $vuln1 = new Vulnerability();
        $vuln1->setScan($this->testScan);
        $vuln1->setTitle('Vulnerability 1');
        $vuln1->setSeverity('high');
        $vuln1->setIgnored(false);

        $vuln2 = new Vulnerability();
        $vuln2->setScan($this->testScan);
        $vuln2->setTitle('Vulnerability 2');
        $vuln2->setSeverity('medium');
        $vuln2->setIgnored(false);

        $this->entityManager->persist($vuln1);
        $this->entityManager->persist($vuln2);
        $this->entityManager->flush();

        $vulnerabilities = $this->repository->findBy(['scan' => $this->testScan]);

        $this->assertCount(2, $vulnerabilities);
    }
}
