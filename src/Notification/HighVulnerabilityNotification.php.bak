<?php

namespace App\Notification;

use App\Entity\RepositoryScan;
use Symfony\Bridge\Twig\Mime\TemplatedEmail;
use Symfony\Component\Mime\Email;
use Symfony\Component\Notifier\Message\ChatMessage;
use Symfony\Component\Notifier\Message\EmailMessage;
use Symfony\Component\Notifier\Notification\ChatNotificationInterface;
use Symfony\Component\Notifier\Notification\EmailNotificationInterface;
use Symfony\Component\Notifier\Notification\Notification;
use Symfony\Component\Notifier\Recipient\EmailRecipientInterface;
use Symfony\Component\Notifier\Recipient\RecipientInterface;
use Symfony\Component\Notifier\Bridge\Slack\SlackOptions;

/**
 * High Vulnerability Count Notification
 * 
 * Sent when a scan completes with vulnerability count exceeding threshold
 */
class HighVulnerabilityNotification extends Notification implements 
    EmailNotificationInterface,
    ChatNotificationInterface
{
    public function __construct(
        private RepositoryScan $scan,
        private int $threshold = 10
    ) {
        parent::__construct(
            subject: 'High Vulnerability Count Detected'
        );
        
        // Set importance based on severity
        $count = $scan->getVulnerabilityCount() ?? 0;
        if ($count > 50) {
            $this->importance(Notification::IMPORTANCE_URGENT);
        } elseif ($count > 20) {
            $this->importance(Notification::IMPORTANCE_HIGH);
        } else {
            $this->importance(Notification::IMPORTANCE_MEDIUM);
        }
    }

    public function asEmailMessage(EmailRecipientInterface $recipient, string $transport = null): ?EmailMessage
    {
        $email = (new TemplatedEmail())
            ->to($recipient->getEmail())
            ->subject($this->getSubject())
            ->htmlTemplate('emails/high_vulnerability.html.twig')
            ->context([
                'repository_name' => $this->scan->getRepository()->getName(),
                'branch' => $this->scan->getBranch() ?? 'main',
                'vulnerability_count' => $this->scan->getVulnerabilityCount(),
                'threshold' => $this->threshold,
                'provider_code' => $this->scan->getProviderCode() ?? 'unknown',
                'scan_id' => $this->scan->getId(),
                'started_at' => $this->scan->getStartedAt()?->format('Y-m-d H:i:s') ?? 'N/A',
                'completed_at' => $this->scan->getCompletedAt()?->format('Y-m-d H:i:s') ?? 'N/A',
            ]);

        // Set priority headers for urgent notifications
        if ($this->getImportance() === Notification::IMPORTANCE_URGENT) {
            $email
                ->priority(Email::PRIORITY_HIGH)
                ->getHeaders()
                ->addTextHeader('X-Priority', '1 (Highest)')
                ->addTextHeader('X-MSMail-Priority', 'High')
                ->addTextHeader('Importance', 'High');
        }

        return new EmailMessage($email);
    }

    public function asChatMessage(RecipientInterface $recipient, string $transport = null): ?ChatMessage
    {
        $message = new ChatMessage($this->buildSlackMessage());
        
        if ($transport === 'slack') {
            $message->options(new SlackOptions());
        }
        
        return $message;
    }

    private function buildSlackMessage(): string
    {
        return sprintf(
            "*High Vulnerability Alert*\n\n" .
            "*Repository:* %s\n" .
            "*Branch:* %s\n" .
            "*Vulnerabilities:* %d (Threshold: %d)\n" .
            "*Provider:* %s\n" .
            "*Scan ID:* `%s`\n" .
            "*Status:* Completed",
            $this->scan->getRepository()->getName(),
            $this->scan->getBranch() ?? 'main',
            $this->scan->getVulnerabilityCount(),
            $this->threshold,
            $this->scan->getProviderCode() ?? 'unknown',
            $this->scan->getId()
        );
    }
}
