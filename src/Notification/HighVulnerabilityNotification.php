<?php

namespace App\Notification;

use Symfony\Bridge\Twig\Mime\TemplatedEmail;
use Symfony\Component\Mime\Email;
use Symfony\Component\Notifier\Message\ChatMessage;
use Symfony\Component\Notifier\Message\EmailMessage;
use Symfony\Component\Notifier\Notification\ChatNotificationInterface;
use Symfony\Component\Notifier\Notification\EmailNotificationInterface;
use Symfony\Component\Notifier\Notification\Notification;
use Symfony\Component\Notifier\Recipient\EmailRecipientInterface;
use Symfony\Component\Notifier\Recipient\RecipientInterface;
use Symfony\Component\Notifier\Bridge\Slack\SlackOptions;

class HighVulnerabilityNotification extends Notification implements 
    EmailNotificationInterface,
    ChatNotificationInterface
{
    private string $scanId;
    private string $repositoryName;
    private string $branch;
    private int $vulnerabilityCount;
    private int $threshold;
    private string $providerCode;
    private ?string $startedAt;
    private ?string $completedAt;

    public function __construct(
        string $scanId,
        string $repositoryName,
        string $branch,
        int $vulnerabilityCount,
        int $threshold = 10,
        string $providerCode = 'unknown',
        ?\DateTimeInterface $startedAt = null,
        ?\DateTimeInterface $completedAt = null,
        array $channels = ['email', 'chat']  // Explicitly specify channels
    ) {
        // Pass channels to parent constructor to control routing
        parent::__construct(subject: 'High Vulnerability Count Detected', channels: $channels);
        
        $this->scanId = $scanId;
        $this->repositoryName = $repositoryName;
        $this->branch = $branch ?: 'main';
        $this->vulnerabilityCount = $vulnerabilityCount;
        $this->threshold = $threshold;
        $this->providerCode = $providerCode;
        $this->startedAt = $startedAt?->format('Y-m-d H:i:s');
        $this->completedAt = $completedAt?->format('Y-m-d H:i:s');
        
        if ($this->vulnerabilityCount > 50) {
            $this->importance(Notification::IMPORTANCE_URGENT);
        } elseif ($this->vulnerabilityCount > 20) {
            $this->importance(Notification::IMPORTANCE_HIGH);
        } else {
            $this->importance(Notification::IMPORTANCE_MEDIUM);
        }
    }
    
    public static function createFromScan(
        \App\Entity\RepositoryScan $scan, 
        int $threshold = 10,
        array $channels = ['email', 'chat']  // Control which channels to use
    ): self {
        return new self(
            (string)$scan->getId(),
            $scan->getRepository()?->getName() ?? 'unknown',
            $scan->getBranch() ?? 'main',
            $scan->getVulnerabilityCount() ?? 0,
            $threshold,
            $scan->getProviderCode() ?? 'unknown',
            $scan->getStartedAt(),
            $scan->getCompletedAt(),
            $channels  // Pass through channels parameter
        );
    }

    public function asEmailMessage(EmailRecipientInterface $recipient, string $transport = null): ?EmailMessage
    {
        $email = (new TemplatedEmail())
            ->to($recipient->getEmail())
            ->subject($this->getSubject())
            ->htmlTemplate('emails/high_vulnerability.html.twig')
            ->context([
                'repository_name' => $this->repositoryName,
                'branch' => $this->branch,
                'vulnerability_count' => $this->vulnerabilityCount,
                'threshold' => $this->threshold,
                'provider_code' => $this->providerCode,
                'scan_id' => $this->scanId,
                'started_at' => $this->startedAt ?? 'N/A',
                'completed_at' => $this->completedAt ?? 'N/A',
            ]);

        if ($this->getImportance() === Notification::IMPORTANCE_URGENT) {
            $email->priority(Email::PRIORITY_HIGH)
                ->getHeaders()
                ->addTextHeader('X-Priority', '1 (Highest)')
                ->addTextHeader('X-MSMail-Priority', 'High')
                ->addTextHeader('Importance', 'High');
        }

        return new EmailMessage($email);
    }

    public function asChatMessage(RecipientInterface $recipient, string $transport = null): ?ChatMessage
    {
        $message = new ChatMessage($this->buildSlackMessage());
        if ($transport && str_contains($transport, 'slack')) {
            $message->options((new SlackOptions())->iconEmoji(':rotating_light:'));
        }
        return $message;
    }

    private function buildSlackMessage(): string
    {
        return sprintf(
            "*High Vulnerability Alert*\n\n" .
            "*Repository:* %s\n*Branch:* %s\n*Vulnerabilities:* %d (Threshold: %d)\n" .
            "*Provider:* %s\n*Scan ID:* `%s`\n*Status:* %s\n",
            $this->repositoryName, $this->branch, $this->vulnerabilityCount,
            $this->threshold, $this->providerCode, $this->scanId,
            $this->completedAt ? 'Completed' : 'In Progress'
        );
    }
}
